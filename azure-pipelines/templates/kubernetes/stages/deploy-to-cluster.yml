parameters:
  - name: stageName
    type: string

  - name: dependsOn
    type: object
    default: []

  - name: environment
    type: string

  - name: regionName
    type: string

  - name: awsCredentials
    type: string

  - name: manifests
    type: object
    default: []

stages:
  - stage: Deploy
    displayName: Deploy k8s ${{ parameters.manifests.name }}
    dependsOn: ${{ parameters.dependsOn }}
    jobs:
      - deployment: Deployment
        displayName: Deployment
        environment: ${{ parameters.environment }}
        variables:
          roleArn: "arn:aws:iam::838062310110:role/azdo-federation"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: Bash@3
                  name: AssumeAWSRole
                  displayName: "Assume AWS role for EKS"
                  inputs:
                    targetType: inline
                    script: |
                      set -e
                      CREDS=$(aws sts assume-role \
                        --role-arn $(roleArn) \
                        --role-session-name "azdo-eks-session" \
                        --duration-seconds 3600)
                  
                      export AWS_ACCESS_KEY_ID=$(echo $CREDS | jq -r .Credentials.AccessKeyId)
                      export AWS_SECRET_ACCESS_KEY=$(echo $CREDS | jq -r .Credentials.SecretAccessKey)
                      export AWS_SESSION_TOKEN=$(echo $CREDS | jq -r .Credentials.SessionToken)
                  
                      echo "âœ… Temporary AWS role credentials configured."
                      aws sts get-caller-identity
                
                - task: Bash@3
                  name: UpdateKubeConfig
                  displayName: Update kube config
                  condition: succeeded(AssumeAWSRole)
                  inputs:
                    targetType: inline
                    script: |
                      aws eks update-kubeconfig \
                        --region ${{ parameters.regionName }} \
                        --name ${{ parameters.clusterName }} \
                        --role-arn $(roleArn)
                  
                - ${{ each item in parameters.manifests }}:
                  - task: Bash@3
                    name: ${{ format('Install{0}', item.name) }}
                    displayName: Install ${{ item.name }} provided manifests
                    inputs:
                      targetType: inline
                      script: |
                        kubectl apply -f ${{ item.manifest }}
        workspace:
          clean: all