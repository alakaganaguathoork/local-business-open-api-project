name: 'eks-$(Date:yyyy-MM-dd)$(Rev:.r)'

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - azure-pipelines/eks.yml

pool:
  name: 'Local'

variables:
  - name: projectRoot
    value: $(System.DefaultWorkingDirectory)
  - name: awsConnector
    value: aws-oidc-federation

stages:
  - stage: EchoJobRoot
    displayName: Show job root
    jobs:
      - job: Deploy
        workspace:
          clean: all
        displayName: Deploy Application
        steps:
        
        - task: Bash@3
          displayName: 'Debug â€” Show current dir'        
          inputs:
            targetType: inline
            script: |
              echo 'Working directory from variables: ${pwd}'
              pwd
          continueOnError: true

        - task: Bash@3
          displayName: 'Install AWS CLI'
          inputs:
            targetType: inline
            script: |
              whoami
              uname -a
              ls -lh .
              curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"
              unzip awscli-bundle.zip
              sudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws
              ls -lh
              rm -r awscli-bundle*

        - script: |
            ls -lha .
            aws --version
          continueOnError: true
        
        - task: AWSCLI@1
          displayName: 'AWSCLI@1 version check'
          inputs:
            awsCredentials: $(awsConnector) 
            awsCommand: aws
            awsSubCommand: --version
        
        - task: Bash@3
          displayName: Uninstall AWC CLI v1
          inputs:
            targetType: inline
            script: |
              sudo rm -rf /usr/local/aws
              sudo rm -rf /usr/local/bin/aws