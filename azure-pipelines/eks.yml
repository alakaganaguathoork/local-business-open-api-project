name: 'eks-$(Date:yyyy-MM-dd)$(Rev:.r)'

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - azure-pipelines/eks.yml

pool:
  name: 'Local'

variables:
  # group:  'AWS'
  azureServiceConnector: 'aws-connector'
  awsRegionName: 'us-east-1'
  projectRoot: $(System.DefaultWorkingDirectory)

stages:
  - stage: DeployToEKS
    displayName: Deploy to EKS
    jobs:
      - job: Deploy
        workspace:
          clean: all
        displayName: Deploy Application
        steps:
        - task: Bash@3
          displayName: 'Debug â€” Show working dir'        
          inputs:
            targetType: inline
            script: |
              echo "Working directory from variables: $(projectRoot)"

        - task: Bash@3
          displayName: 'Intall AWS CLI'
          inputs:
            targetType: inline
            script: |
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip awscliv2.zip
              sudo ./aws/install --update

        - task: AWSCLI@1
          displayName: "Running aws-cli get-caller-identity"
          # continueOnError: true # If you need the pipeline to succeed
          inputs:
            awsCredentials: $(azureServiceConnector)
            regionName: $(awsRegionName)
            awsCommand: 'sts'
            awsSubCommand: 'get-caller-identity'

        # - task: KubernetesManifest@1
          # displayName: Deploy Kubernetes Manifests
          # inputs:
            # action: 'deploy'
            # kubernetesServiceConnection: 'aws-connection' # Create a Kubernetes service connection to your EKS cluster
            # namespace: 'nginx-ns'
            # manifests: |
              # /terraform/aws/projects/eks-deployments/yamls/deployments/deployment.yaml
            # workingDirectory: $(projectRoot)
