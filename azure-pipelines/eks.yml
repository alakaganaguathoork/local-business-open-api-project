name: 'eks-$(Date:yyyy-MM-dd)$(Rev:.r)'

trigger: none
pr: none

# trigger:
  # branches:
    # include:
      # - main
  # paths:
    # include:
      # - azure-pipelines/eks.yml
      # - azure-pipelines/templates/aws/stages/*

resources:
  webhooks:
    - webhook: TerraformApplied
      connection: TerraformAppliedServiceConnection

pool:
  name: 'Local'

variables:
  - name: installAWS
    value: true

  - name: projectRoot
    value: $(System.DefaultWorkingDirectory)

  - name: awsCredentials
    value: aws-oidc-federation

  - name: regionName
    value: us-east-1 
  
  - name: clusterName
    value: terraform-test

stages:
  - template: ./templates/aws/stages/install-aws.yml
    parameters:
      stageName: InstallAWSCLIv1
      installAWS: ${{ variables.installAWS }}
      awsCredentials: $(awsCredentials)

  - stage: GetEKSClusterInfo
    dependsOn:
      - InstallAWSCLIv1
    displayName: Get EKS Cluster Info
    jobs:
      - job: GetEKSClusterInfo
        displayName: Get EKS Cluster Info
        steps:
          - task: AWSCLI@1
            displayName: Get EKS Cluster Info
            inputs:
              awsCredentials: $(awsCredentials)
              regionName: $(regionName)
              awsCommand: eks
              awsSubCommand: describe-cluster
              awsArguments: --name ${{ variables.clusterName }} | jq '.cluster.arn'

  - template: ./templates/aws/stages/delete-aws.yml 
    parameters: 
      dependsOn: GetEKSClusterInfo
      stageName: DeleteAWSCLIv1