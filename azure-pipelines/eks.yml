name: $(Date:yyyy-MM-dd)$(Rev:.r)-$(Build.SourceBranchName)

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - azure-pipelines/eks.yml
      - azure-pipelines/templates/*

resources:
  webhooks:
    - webhook: TerraformApplied
      connection: TerraformAppliedServiceConnection

pool:
  name: 'Local'

variables:
  - group: AWS

  - name: projectRoot
    value: $(System.DefaultWorkingDirectory)
  - name: awsCredentials
    value: aws-oidc-federation
  - name: environment
    value: eks-$(Build.SourceBranchName)
  - name: regionName
    value: us-east-1 
  - name: clusterName
    value: terraform-test
  - name: k8sVersion
    value: 1.33.0

stages:
  - stage: Deploy
    displayName: Deploy resources to the '${{ variables.clusterName }}' EKS cluster
    jobs:
      - template: ./templates/setup-env.yml
        parameters:
          action: install
          utilities: 
            - name: aws
            - name: kubectl
      
      - template: ./templates/aws/configure.yml
        parameters:
          dependsOn: installUtilities

      - template: ./templates/kubernetes/jobs/deploy-to-cluster.yml
        parameters:
          deploymentName: Deploy
          dependsOn: Configure
          environment: $(environment)
          regionName: $(regionName)
          awsCredentials: $(awsCredentials)
          awsAccountId: $(AWS_ACCOUNT_ID)
          clusterName: $(clusterName)
          manifests:
            - name: namespace
              manifest: $(System.DefaultWorkingDirectory)/terraform/aws/projects/eks-deployments/yamls/namespace.yml
            - name: deployment
              manifest: $(System.DefaultWorkingDirectory)/terraform/aws/projects/eks-deployments/yamls/deployments/nginx/deployment.yml
            - name: service
              manifest: $(System.DefaultWorkingDirectory)/azure-pipelines/service.yml 
          
      - template: ./templates/setup-env.yml
        parameters:
          action: uninstall
          dependsOn: Deploy
          utilities:
            - name: aws
            - name: kubectl