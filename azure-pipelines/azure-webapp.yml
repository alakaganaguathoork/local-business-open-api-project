trigger:
  branches:
    include:
      - azure-pipeline

variables:
  azureServiceConnectorId: "7a9cf0e8-68d1-4cdc-82c7-d96cca6b8858"
  appName: "app-1-9kvuVT2"
  appType: "webAppLinux"
  resourceGroupName: "resource-group-test"
  projectRoot: $(System.DefaultWorkingDirectory)
  pythonVersion: "3.12"


pool:
  name: Local

stages:
  - stage: Build
    variables:
      - group: Main
    jobs:
      - job: CreateEnvFile
        steps:
          - bash: touch .env
            name: CreateEnvFile
            displayName: "Create .env file"
            workingDirectory: app
          
          - bash: |
              echo "$(variables.APP_ENV)" >> ./.env
              echo "$(variables.X_RAPIDAPI_KEY)" >> ./.env
            name: SaveEnvVaribalesInFile
            displayName: "Save env varibales in .env"

  - stage: Deploy
    dependsOn: Build
    condition: succeeded()
    displayName: Deploy
    jobs:
      - job: DeployApp
        steps: 
        - task: ArchiveFiles@2
          inputs:
            rootFolderOrFile: 'app'
            includeRootFolder: false
            archiveType: 'zip'
            archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
            replaceExistingArchive: true
          displayName: "Archive Python App"

        - task: AzureWebApp@1
          inputs:
            azureSubscription: "$(azureServiceConnectorId)"
            appName: "$(appName)"
            appType: webAppLinux
            resourceGroupName: "$(resourceGroupName)"
            package: "$(Build.ArtifactStagingDirectory)/app.zip"
            runtimeStack: "PYTHON|3.12"
            startUpCommand: "gunicorn --bind=0.0.0.0 --timeout 600 app:app"
          displayName: "Deploy to Azure App Service"

