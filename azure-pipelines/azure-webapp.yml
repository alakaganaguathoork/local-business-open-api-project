name: 'appDeploy-$(Date:yyyy-MM-dd)$(Rev:.r)'

trigger:
  branches:
    include:
    - azure-pipeline
  paths:
    include:
    - app/*
    - azure-pipelines/templates/*
    - azure-pipelines/azure-webapp.yml

variables:
- name: azureServiceConnectorId 
  value: "azure-connector"
- name: projectRoot 
  value: $( System.DefaultWorkingDirectory )
- name: pythonVersion
  value: "3.13"
  # apps: | 
    # [
      # "app1": 'name: "app-1-27rbhbD"
      # type: "webAppLinux"
      # resourceGroup: "resource-group-test"'
    # ]
pool:
  name: Local

stages:
  - stage: BuildAndDeploy
    variables:
    - group: Main
    jobs:
    - job: GetAppDataJob
      steps:
      - template: templates/get-app-service-data-template.yml 
        parameters:
          azureServiceConnectorId: $( azureServiceConnectorId )
    
    - job: BuildAndDeploy
      displayName: "Build and Deploy"
      dependsOn: GetAppDataJob
      condition: succeeded()
      variables:
      - name: apps
        value: $[ dependencies.GetAppDataJob.outputs['GetAppDataTask.apps'] ]
      steps:
      - ${{ each app in variables.apps }}:
        - template: templates/deploy-web-app-template.yml
          parameters:
            azureServiceConnectorId: ${{ azureServiceConnectorId }}
            projectRoot: ${{ projectRoot }}
            appName: ${{ app.name }}
            appType: ${{ app.type }}
            appResourceGroup: ${{ app.resourceGroup }}
            pythonVersion: ${{ pythonVersion }}
      