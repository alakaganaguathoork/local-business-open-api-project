name: 'appDeploy-$(Date:yyyy-MM-dd)$(Rev:.r)'

trigger:
  branches:
    include:
    - azure-pipeline
  paths:
    include:
    - app/*
    - azure-pipelines/templates/*
    - azure-pipelines/azure-webapp.yml

variables:
  group: Main

  azureServiceConnectorId: azure-connector
  projectRoot: $( System.DefaultWorkingDirectory )
  pythonVersion: "3.13"
  apps: | 
    [
      {
        "name": "app-1-R3Bufsq",
        "appType": "webAppLinux",
        "resourceGroup": "resource-group-test"
      }
    ]
  
pool:
  name: Local

stages:
  - stage: BuildAndDeploy
    variables:
    - group: Main
    jobs:
    - job: GetAppDataJob
      steps:
      - template: templates/get-app-service-data.yml 
        parameters:
          azureServiceConnectorId: $( azureServiceConnectorId )
    
    - job: BuildAndDeploy
      dependsOn: GetAppDataJob
      variables:
        apps: ${{ fromJson(dependencies.GetAppDataJob.outputs['GetAppDataTask.apps']) }}
      steps:
      - template: templates/deploy-web-app-template.yml
        parameters:
          azureServiceConnectorId: $( azureServiceConnectorId )
          projectRoot: $( projectRoot )
          apps: ${{ variables.apps }}
          pythonVersion: $( pythonV"appersion )